# 性能优化

最近面试过程中，几乎所有公司都会提及性能优化问题。可以看出随着前端工程化开发，vue等框架渐渐成熟后，更多公司开始关注性能方面优化来提供产品的用户体验。

**那从用户角度来说，哪些能提高用户体验呢？**

答： 一者是**页面加载**的很快，是页面**使用起来很流畅**。

下面就从这两点，结合网络上优秀的文章，整理如下资料：



### 1. 页面加载

#### **1.1 首先解决问题**

从浏览器打开到页面渲染完成，经历了什么？都花费了多少时间？

答：

- 先分析一个页面从请求到渲染完做了什么？

  浏览器解析->查询缓存->dns查询->建立链接->服务器处理请求->服务器发送响应->客户端收到页面->解析HTML->构建渲染树->开始显示内容(白屏时间)->首屏内容加载完成(首屏时间)->用户可交互(DOMContentLoaded)->加载完成(load)

  ​

- 前端怎么监控页面请求过程的时间？

  首先推荐一个[PerformanceTiming](https://link.juejin.im/?target=https%3A%2F%2Fdeveloper.mozilla.org%2Fzh-CN%2Fdocs%2FWeb%2FAPI%2FPerformanceTiming)，是一个HTML5的方法，可以获取到很多页面加载相关的数据，如果不使用该API，可以以服务器渲染返回的时间。先来看看在 Chrome 浏览器控制台中执行 window.performance 会出现什么：

  ![072455Nu](/Users/ex_wljr_sunchen/Documents/summarize/【学习】性能优化/072455Nu.jpeg)

  ​

  一张图简单解释下 performance 中的属性：

  ![072455NuJ](/Users/ex_wljr_sunchen/Documents/summarize/【学习】性能优化/072455NuJ.png)

  一般常用的数据如下：

  ```
  DNS解析时间： domainLookupEnd - domainLookupStart
  TCP建立连接时间： connectEnd - connectStart
  白屏时间： responseStart - navigationStart
  dom渲染完成时间： domContentLoadedEventEnd - navigationStart
  页面onload时间： loadEventEnd - navigationStart
  ```

  详情请查看：[初探 performance – 监控网页与程序性能](http://www.alloyteam.com/2015/09/explore-performance/)




#### **1.2 如何优化**

答：页面请求过程中每一部分的时间都知道了，就可以**针对性**的优化。结合Yahoo前端性能团队总结的35条黄金定律：

> Yahoo 的Excetional Performance 团队总结出了一系列可以提高网站速度的方法。可以分为 7大类 35条（包括内容、服务器、CSS、JavaScript、Cookie、图片、移动应用）。



- **页面内容**
  - **减少 HTTP 请求数**
  - **减少 DNS 查询**
  - **避免重定向**
  - **缓存 Ajax 请求**
  - **延迟加载**
  - **预先加载**
  - **减少 DOM 元素数量**
  - **划分内容到不同域名**
  - **尽量减少 iframe 使用**
  - **避免 404 错误**
- **服务器**
  - **使用 CDN**
  - **添加 Expires 或 Cache-Control 响应头**
  - **启用 Gzip**
  - **配置 Etag**
  - **尽早输出缓冲**
  - **Ajax 请求使用 GET 方法**
  - **避免图片 src 为空**
- **Cookie**
  - **减少 Cookie 大小**
  - **静态资源使用无 Cookie 域名**
- **CSS**
  - **把样式表放在 `<head> `中**
  - **不要使用 CSS 表达式**
  - **使用` <link>` 替代 @import**
  - **不要使用 filter**
- **JavaScript**
  - **把脚本放在页面底部**
  - **使用外部 JavaScript 和 CSS**
  - **压缩 JavaScript 和 CSS**
  - **移除重复脚本**
  - **减少 DOM 操作**
  - **使用高效的事件处理**
- **图片**
  - **优化图片**
  - **优化 CSS Sprite**
  - **不要在 HTML 中缩放图片**
  - **使用体积小、可缓存的 favicon.ico**
- **移动端**
  - **保持单个文件小于 25 KB**
  - **打包内容为分段（multipart）文档**



**减少 HTTP 请求数：**

从发起请求到页面渲染，绝大部分时间花费在网络请求响应上，那么缩短网络请求响应时间，就变成首要解决的问题。减少HTTP请求会很有效的缩短时间，因为**浏览器对每个域名并行请求数量**是有限制的。

- 合并js，css
- 精灵图
- 图片转base64
- HTTP2的多路复用，大幅度降低多文件请求的开销，具体可以自行百度HTTP2(暂时覆盖率不高)



**减少 DNS 查询**

从输入URL访问通过DNS解析至对应IP地址，需要一定的时间，且这段时间是**等待**状态不会处理任何事。那么减少DNS数量和DNS查询时间也可以减少请求时间。

```html
<!-- DNS预获取 -->
<link rel="dns-prefetch" href="https://www.zhix.net">
<link rel="dns-prefetch" href="https://api.share.zhix.net">
```



**避免重定向**

尽可能避免使用重定向，除非迫不得已重定向至404页面。

最浪费的重定向经常发生，而且很容易被忽略：URL 末尾应该添加 `/` 但未添加。比如，访问 `http://astrology.yahoo.com/astrology` 将被 301 重定向到 `http://astrology.yahoo.com/astrology/`



**缓存异步请求**

Ajax异步请求虽然不刷新页面，但是改变不了异步的本性，所以在特定的情况下，可以缓存住某些非经常变动的数据。可以通过设置合适的 [`Cache-Control`](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Cache-Control) 响应头，让浏览器有条件地发起请求。

鉴于静态内容和动态内容不同的缓存策略，实践中一般会把二者部署在不同的服务器（域名）以方便管理。



**延迟加载**

非首屏使用的数据、样式、脚本、图片等，以及用户交互时才会显示的内容都可以通过懒加载方式加载，减少首屏时间。

- `script`标签的defer属性，async属性(不能保证按顺序)
- 图片懒加载
- 监听load事件后，动态加载需要的文件；setTimeout放在队列最后加载。













> [当面试官问你如何进行性能优化时，你该这么回答(一)](https://juejin.im/post/5a99f80cf265da238c3a1e16)
>
> 

